---
import { getCollection } from 'astro:content';
import '../styles/global.css'; 

const allSpots = await getCollection('spots');
// ì´ˆê¸° ì •ë ¬: ê±°ë¦¬ìˆœ
allSpots.sort((a, b) => a.data.distance - b.data.distance);

// ì¹´ìš´íŠ¸ ê³„ì‚°
const categoryCounts = allSpots.reduce((acc, spot) => {
    acc[spot.data.category] = (acc[spot.data.category] || 0) + 1;
    return acc;
}, {});
const regionCounts = allSpots.reduce((acc, spot) => {
    acc[spot.data.region] = (acc[spot.data.region] || 0) + 1;
    return acc;
}, {});

const renderedSpots = await Promise.all(allSpots.map(async (spot) => {
  const { Content } = await spot.render();
  return { ...spot, Content };
}));
---

<html lang="ko">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<title>ì§€ë¦¬ì‚°ìƒíƒœíƒë°©ì› ì¸ê·¼ ê´€ê´‘ì§€ ì•ˆë‚´</title>
        <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=an3gqg9xly"></script>
	</head>
	<body class="bg-slate-50 text-slate-800 font-sans">
        
		<header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
            <div class="max-w-3xl mx-auto px-4 py-6 flex flex-col items-center justify-center">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-3xl">ğŸ”</span>
			        <h1 class="text-2xl font-bold text-slate-800 tracking-tight cursor-pointer" onclick="location.reload()">
                        ì§€ë¦¬ì‚°ìƒíƒœíƒë°©ì› ì¸ê·¼ ê´€ê´‘ì§€ ì•ˆë‚´
                    </h1>
                </div>
                <span class="text-xs text-slate-500 bg-slate-100 px-3 py-1 rounded-full font-medium">ì „ë‚¨ êµ¬ë¡€êµ° ë§ˆì‚°ë©´ í™”ì—„ì‚¬ë¡œ 402-25 ê¸°ì¤€</span>
            </div>
		</header>

        <main class="max-w-3xl mx-auto p-4 pb-20">
            
            <!-- í†µí•© ê²€ìƒ‰ì°½ -->
            <div class="relative mb-8 mt-2">
                <input type="text" id="searchInput" placeholder="ê´€ê´‘ì§€ ì´ë¦„ ê²€ìƒ‰ (ì˜ˆ: í™”ì—„ì‚¬, ë…¸ê³ ë‹¨)" 
                    class="w-full p-3.5 pl-11 bg-white border border-slate-300 rounded-xl text-base focus:outline-none focus:border-slate-600 focus:ring-1 focus:ring-slate-600 transition-all shadow-sm">
                <span class="absolute left-4 top-4 text-slate-400 text-lg">ğŸ”</span>
            </div>
            
            <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
            <p class="text-xs text-slate-500 text-center mb-6">
                ğŸ’¡ ê´€ê´‘ì§€ ì´ë¦„ì„ í´ë¦­í•˜ì‹œë©´ ìì„¸í•œ ë‚´ìš©ì„ ë³´ì‹¤ ìˆ˜ ìˆì–´ìš”
            </p>

            <!-- íƒ­ ë©”ë‰´ -->
            <div class="flex border-b border-slate-200 mb-6">
                <button class="main-tab active flex-1 py-3 text-sm font-bold text-slate-400 border-b-2 border-transparent hover:text-slate-600 transition-colors" data-mode="category">
                    ğŸ“ ê±°ë¦¬ìˆœ ({allSpots.length})
                </button>
                <button class="main-tab flex-1 py-3 text-sm font-bold text-slate-400 border-b-2 border-transparent hover:text-slate-600 transition-colors" data-mode="region">
                    ğŸ“ ì§€ìì²´ë³„
                </button>
                <a href="https://exam1-beige.vercel.app/" target="_blank" class="flex-1 py-3 text-sm font-bold text-green-600 border-b-2 border-transparent hover:text-green-800 hover:bg-slate-50 transition-colors text-center flex items-center justify-center gap-1">
                    ğŸ›ï¸ êµ­ê°€ìœ ì‚° ê²€ìƒ‰ <span class="text-xs">â†—</span>
                </a>
            </div>

            <!-- í•˜ìœ„ í•„í„° -->
            <div id="sub-filter-container" class="mb-8 flex flex-wrap gap-2 justify-center"></div>

            <!-- ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
            <div id="spot-list" class="space-y-3">
                {renderedSpots.map((spot) => (
                    <div class="spot-item group">
                        <!-- ì¹´ë“œ í—¤ë” -->
                        <div class="spot-header bg-white rounded-xl border border-slate-200 p-5 cursor-pointer hover:shadow-md hover:border-slate-300 transition-all flex justify-between items-center"
                            data-title={spot.data.title}
                            data-category={spot.data.category}
                            data-region={spot.data.region}
                            data-distance={spot.data.distance}
                        >
                            <div class="flex items-center gap-3">
                                <div class="flex flex-col gap-1 items-start">
                                    <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100 font-bold">{spot.data.region}</span>
                                    <span class={`text-[10px] px-2 py-0.5 rounded border font-bold ${
                                        spot.data.category === 'ìì—°' ? 'bg-green-50 text-green-700 border-green-100' :
                                        spot.data.category === 'ë¬¸í™”ìœ ì‚°' ? 'bg-orange-50 text-orange-700 border-orange-100' :
                                        'bg-slate-100 text-slate-600 border-slate-200'
                                    }`}>{spot.data.category}</span>
                                </div>
                                <h2 class="text-lg font-bold text-slate-800 group-hover:text-slate-600 transition-colors">{spot.data.title}</h2>
                            </div>
                            
                            <div class="text-right min-w-[80px]">
                                <div class="text-base font-bold text-green-700">{spot.data.distance}km</div>
                                <div class="text-xs text-slate-400 font-medium">({spot.data.time})</div>
                            </div>
                        </div>

                        <!-- ìƒì„¸ ë‚´ìš© -->
                        <div class="detail-area hidden bg-slate-50 border-x border-b border-slate-200 rounded-b-xl p-5 animate-fade-in">
                             
                            <p class="text-sm text-slate-500 mb-5 flex items-start gap-1 pb-4 border-b border-slate-200">
                                <span class="shrink-0">ğŸ“</span> <span class="font-medium">{spot.data.address}</span>
                            </p>

                            <div class="prose prose-sm max-w-none mb-6 text-slate-700 leading-relaxed bg-white p-4 rounded-lg border border-slate-100">
                                <spot.Content />
                            </div>

                            <div class="mb-5">
                                <button class="w-full py-3 bg-white border border-slate-300 rounded-lg text-slate-700 font-bold flex items-center justify-center gap-2 hover:bg-slate-100 transition shadow-sm map-toggle-btn"
                                    data-lat={spot.data.lat} 
                                    data-lng={spot.data.lng}
                                    id={`btn-map-${spot.slug}`}
                                >
                                    ğŸ—ºï¸ ì§€ë„ ë³´ê¸°
                                </button>
                                <div id={`map-${spot.slug}`} class="w-full h-72 bg-slate-200 rounded-lg mt-2 hidden relative overflow-hidden border border-slate-300"></div>
                            </div>

                            <div class="flex gap-2">
                                <a href={`https://www.google.com/search?q=${spot.data.region} ${spot.data.title}`} target="_blank" class="flex-1 py-3 bg-white border border-slate-300 rounded-lg text-center text-sm font-bold text-slate-600 hover:bg-slate-50 hover:text-slate-800 hover:border-slate-400 transition shadow-sm">
                                    G êµ¬ê¸€
                                </a>
                                <a href={`https://www.youtube.com/results?search_query=${spot.data.region} ${spot.data.title}`} target="_blank" class="flex-1 py-3 bg-white border border-slate-300 rounded-lg text-center text-sm font-bold text-slate-600 hover:bg-slate-50 hover:text-slate-800 hover:border-slate-400 transition shadow-sm">
                                    ğŸ“º ìœ íŠœë¸Œ
                                </a>
                                <a href={`https://exam1-beige.vercel.app/?q=${spot.data.title}`} target="_blank" class="flex-1 py-3 bg-slate-700 text-white rounded-lg text-center text-sm font-bold shadow-sm hover:bg-slate-800 transition border border-slate-700">
                                    ğŸ›ï¸ êµ­ê°€ìœ ì‚°
                                </a>
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            <div id="no-result" class="hidden text-center py-20">
                <span class="text-4xl mb-2 block">ğŸ¤”</span>
                <span class="text-slate-400 font-medium">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
            </div>
            
            <div class="text-center mt-8">
                <button id="loadMoreBtn" class="hidden px-8 py-3 bg-white border border-slate-300 rounded-full text-slate-600 font-bold shadow-sm hover:bg-slate-50 transition text-sm">
                    ê²°ê³¼ ë”ë³´ê¸° +
                </button>
            </div>
        </main>

        <!-- ê´€ë ¨ ì‚¬ì´íŠ¸ ë§í¬ -->
        <div class="related-section max-w-3xl mx-auto px-4 mb-10">
            <h3 class="text-sm text-slate-400 text-center mb-4 font-medium">ê´€ë ¨ ì‚¬ì´íŠ¸ ë°”ë¡œê°€ê¸°</h3>
            <div class="grid grid-cols-3 sm:grid-cols-5 gap-2">
                <a href="https://www.youtube.com/channel/UCWJHLijeKNpQpFq_bn63TKw" target="_blank" class="link-card">
                    <span class="text-xl mb-1">ğŸ“º</span><span>ìƒíƒœíƒë°©ì›<br>ìœ íŠœë¸Œ</span>
                </a>
                <a href="https://www.facebook.com/jirisan.NC/" target="_blank" class="link-card">
                    <span class="text-xl mb-1">ğŸ“˜</span><span>í˜ì´ìŠ¤ë¶</span>
                </a>
                <a href="https://www.instagram.com/jirisan_naturecenter/" target="_blank" class="link-card">
                    <span class="text-xl mb-1">ğŸ“·</span><span>ì¸ìŠ¤íƒ€ê·¸ë¨</span>
                </a>
                <a href="https://reservation.knps.or.kr/" target="_blank" class="link-card">
                    <span class="text-xl mb-1">ğŸ“…</span><span>êµ­ë¦½ê³µì›<br>ì˜ˆì•½</span>
                </a>
                <a href="https://www.knps.or.kr/front/portal/safe/acsCtrList.do?menuNo=8000340" target="_blank" class="link-card">
                    <span class="text-xl mb-1">ğŸš§</span><span>íƒë°©ë¡œ<br>í†µì œì •ë³´</span>
                </a>
            </div>
        </div>

        <!-- âœ¨ í‘¸í„° ë³µêµ¬ (ë¬¸ì˜í•˜ê¸° & ë°©ë¬¸ì ìˆ˜) -->
<div class="footer">
        - Made by ì´íƒœê±´ -<br>
        <span class="contact-link" onclick="copyEmail()">ğŸ“© ë¬¸ì˜í•˜ê¸° (Contact)</span><br>
        <div class="hits-badge">
            <img src="https://api.visitorbadge.io/api/visitors?path=https%3A%2F%2Fexam1-beige.vercel.app&countColor=%232C3E50&style=flat" />
        </div>
    </div>

        <style is:global>
            .main-tab.active { color: #1e293b; border-color: #1e293b; }
            
            .filter-chip { 
                display: inline-flex; 
                align-items: center;
                justify-content: center;
                padding: 8px 18px; 
                font-size: 0.95rem; 
                font-weight: 500; 
                color: #4b5563; 
                background-color: white; 
                border: 1px solid #d1d5db; 
                border-radius: 9999px; 
                cursor: pointer; 
                transition: all 0.2s; 
                box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            }
            .filter-chip:hover { 
                background-color: #f3f4f6; 
                border-color: #9ca3af;
                color: #1f2937;
            }
            .filter-chip.active { 
                background-color: #2c3e50; 
                color: white; 
                border-color: #2c3e50; 
                font-weight: 700; 
                box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            }

            .link-card {
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                background: white; border: 1px solid #e2e8f0; border-radius: 12px;
                padding: 12px 5px; text-align: center; text-decoration: none;
                color: #64748b; font-size: 0.8em; font-weight: 600;
                transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
                height: 80px;
            }
            .link-card:hover { transform: translateY(-3px); border-color: #2c3e50; color: #2c3e50; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

            /* í‘¸í„° ìŠ¤íƒ€ì¼ */
            .footer { text-align: center; margin-top: 20px; padding-top: 30px; border-top: 1px solid #e2e8f0; color: #64748b; font-size: 0.85em; line-height: 1.8; }
            .footer a { color: #64748b; text-decoration: none; border-bottom: 1px dotted #94a3b8; }
            
            .contact-link { display: inline-block; margin-top: 5px; cursor: pointer; color: #475569; font-weight: 600; transition: 0.2s; }
            .contact-link:hover { color: #2c3e50; text-decoration: underline; }
            
            .hits-badge { margin-top: 15px; display: inline-block; opacity: 0.8; transition: opacity 0.2s; }
            .hits-badge:hover { opacity: 1; }
            .hits-badge img { height: 20px; vertical-align: middle; }

            @keyframes fade-in { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
            .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
        </style>

        <script define:vars={{ categoryCounts, regionCounts, allSpotsLength: allSpots.length, myEmail: "naturekr@gmail.com" }}>
            window.categoryCounts = categoryCounts;
            window.regionCounts = regionCounts;
            window.allSpotsLength = allSpotsLength;
            window.myEmail = myEmail;
        </script>

        <script>
            const searchInput = document.getElementById('searchInput');
            const subFilterContainer = document.getElementById('sub-filter-container');
            const noResult = document.getElementById('no-result');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            
            const spotItems = Array.from(document.querySelectorAll('.spot-item')); // ë°°ì—´ë¡œ ë³€í™˜
            const mainTabs = document.querySelectorAll('.main-tab');

            const categories = ["ì „ì²´", "ìì—°", "ë¬¸í™”ìœ ì‚°", "êµ­ë¦½ê³µì›ì‹œì„¤", "ì •ì›", "ê¸°íƒ€"]; 
            const regions = ["ì „ì²´", "êµ¬ë¡€", "í•˜ë™", "ë‚¨ì›", "ìˆœì²œ", "í•¨ì–‘", "ì‚°ì²­", "ê³¡ì„±"]; 

            // ë”ë³´ê¸° ê¸°ëŠ¥ ë³€ìˆ˜
            let limit = 10;
            let currentFilteredItems = []; 

            // ì´ˆê¸° ì‹¤í–‰
            renderSubChips(categories, 'category');
            filterAndPagination('all', 'ì „ì²´'); 

            // ì´ë©”ì¼ ë³µì‚¬
            window.copyEmail = function() {
                navigator.clipboard.writeText(window.myEmail).then(() => {
                    alert(`ğŸ“§ ì´ë©”ì¼ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n(${window.myEmail})`);
                });
            };

            // íƒ­ ì „í™˜
            mainTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // ë§í¬ ë²„íŠ¼(êµ­ê°€ìœ ì‚° ê²€ìƒ‰)ì€ íƒ­ ë¡œì§ì—ì„œ ì œì™¸
                    if(tab.tagName === 'A') return;

                    mainTabs.forEach(t => {
                        if(t.tagName !== 'A') t.classList.remove('active');
                    });
                    tab.classList.add('active');
                    const mode = tab.getAttribute('data-mode');
                    
                    if (mode === 'category') renderSubChips(categories, 'category');
                    else if (mode === 'region') renderSubChips(regions, 'region');
                    
                    // íƒ­ ë³€ê²½ ì‹œ ì „ì²´ ë³´ê¸°ë¡œ ë¦¬ì…‹
                    const allBtn = subFilterContainer.querySelector('button');
                    if(allBtn) allBtn.click();
                });
            });

            // ì¹© ìƒì„±
            function renderSubChips(items, type) {
                subFilterContainer.innerHTML = '';
                items.forEach(item => {
                    let count = 0;
                    if (item === 'ì „ì²´') count = window.allSpotsLength;
                    else count = (type === 'category' ? window.categoryCounts[item] : window.regionCounts[item]) || 0;

                    if(count > 0) {
                        const btn = document.createElement('button');
                        btn.className = 'filter-chip'; 
                        if(item === 'ì „ì²´') btn.classList.add('active');
                        btn.innerText = `${item} (${count})`;
                        
                        btn.onclick = () => {
                            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                            btn.classList.add('active');
                            
                            limit = 10; 
                            if(item === 'ì „ì²´') filterAndPagination('all', 'ì „ì²´');
                            else filterAndPagination(type, item);
                        };
                        subFilterContainer.appendChild(btn);
                    }
                });
            }

            // í•„í„°ë§ + í˜ì´ì§€ë„¤ì´ì…˜
            function filterAndPagination(type, value) {
                const keyword = searchInput.value.toLowerCase();
                
                currentFilteredItems = spotItems.filter(item => {
                    const header = item.querySelector('.spot-header');
                    const title = header.getAttribute('data-title').toLowerCase();
                    const cardValue = header.getAttribute(`data-${type}`);
                    
                    const matchesSearch = title.includes(keyword);
                    const matchesFilter = (value === 'ì „ì²´') || (cardValue === value);
                    
                    return matchesSearch && matchesFilter;
                });

                updateDisplay();
            }

            function updateDisplay() {
                spotItems.forEach(item => item.style.display = 'none');
                currentFilteredItems.slice(0, limit).forEach(item => {
                    item.style.display = 'block';
                });
                noResult.style.display = currentFilteredItems.length === 0 ? 'block' : 'none';

                if (currentFilteredItems.length > limit) {
                    loadMoreBtn.style.display = 'inline-block';
                    const remain = currentFilteredItems.length - limit;
                    loadMoreBtn.innerText = `ê²°ê³¼ ë”ë³´ê¸° + (${remain}ê°œ ë‚¨ìŒ)`;
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            }

            loadMoreBtn.addEventListener('click', () => {
                limit += 10;
                updateDisplay();
            });

            searchInput.addEventListener('input', () => {
                const activeTab = document.querySelector('.main-tab.active');
                const mode = activeTab.getAttribute('data-mode');
                const activeChip = document.querySelector('.filter-chip.active');
                
                let filterValue = 'ì „ì²´';
                if (activeChip) {
                    filterValue = activeChip.innerText.split(' (')[0];
                }
                
                limit = 10; 
                if (filterValue === 'ì „ì²´') filterAndPagination('all', 'ì „ì²´');
                else filterAndPagination(mode, filterValue);
            });

            document.querySelectorAll('.spot-header').forEach(header => {
                header.addEventListener('click', () => {
                    const detail = header.nextElementSibling;
                    detail.classList.toggle('hidden');
                });
            });

            document.querySelectorAll('.map-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const lat = parseFloat(btn.getAttribute('data-lat'));
                    const lng = parseFloat(btn.getAttribute('data-lng'));
                    const mapDiv = btn.nextElementSibling;
                    
                    if(mapDiv.classList.contains('hidden')) {
                        mapDiv.classList.remove('hidden');
                        btn.innerText = "ğŸ—ºï¸ ì§€ë„ ë‹«ê¸°";
                        
                        if(!mapDiv.hasChildNodes()) {
                            if(typeof naver === "undefined") {
                                mapDiv.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">ì§€ë„ API ë¡œë”© ì‹¤íŒ¨ (localhost ë“±ë¡ í™•ì¸ í•„ìš”)</div>';
                                return;
                            }
                            const map = new naver.maps.Map(mapDiv, {
                                center: new naver.maps.LatLng(lat, lng),
                                zoom: 14
                            });
                            new naver.maps.Marker({ position: new naver.maps.LatLng(lat, lng), map: map });
                        }
                    } else {
                        mapDiv.classList.add('hidden');
                        btn.innerText = "ğŸ—ºï¸ ì§€ë„ ë³´ê¸°";
                    }
                });
            });
        </script>
	</body>
</html>