---
import { getCollection } from 'astro:content';
import '../styles/global.css'; 

const allSpots = await getCollection('spots');
// ì´ˆê¸° ì •ë ¬: ê±°ë¦¬ìˆœ
allSpots.sort((a, b) => a.data.distance - b.data.distance);

// âœ¨ ì¹´ìš´íŠ¸ ê³„ì‚° ë¡œì§
const categoryCounts = allSpots.reduce((acc, spot) => {
    acc[spot.data.category] = (acc[spot.data.category] || 0) + 1;
    return acc;
}, {});
const regionCounts = allSpots.reduce((acc, spot) => {
    acc[spot.data.region] = (acc[spot.data.region] || 0) + 1;
    return acc;
}, {});

// HTML ë³¸ë¬¸(Content) ë¯¸ë¦¬ ë Œë”ë§í•´ì„œ ê°ì²´ì— ë‹´ê¸° (ì•„ì½”ë””ì–¸ìš©)
const renderedSpots = await Promise.all(allSpots.map(async (spot) => {
  const { Content } = await spot.render();
  return { ...spot, Content };
}));
---

<html lang="ko">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<title>ì§€ë¦¬ì‚° ìƒíƒœíƒë°©ì› ì¸ê·¼ ê´€ê´‘ì§€</title>
        <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=an3gqg9xly"></script>
	</head>
	<body class="bg-gray-50 text-gray-800 font-sans">
        
		<header class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-3xl mx-auto px-4 py-4 flex justify-between items-center">
			    <h1 class="text-xl font-bold text-gray-800">
                    â›°ï¸ ì§€ë¦¬ì‚° ì¸ê·¼ ê´€ê´‘ì§€
                </h1>
                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">íƒë°©ì› ê¸°ì¤€</span>
            </div>
		</header>

        <main class="max-w-3xl mx-auto p-4 pb-20">
            
            <!-- í†µí•© ê²€ìƒ‰ì°½ -->
            <div class="relative mb-6">
                <input type="text" id="searchInput" placeholder="ê´€ê´‘ì§€ ì´ë¦„ ê²€ìƒ‰" 
                    class="w-full p-3 pl-10 bg-white border border-gray-300 rounded-lg text-base focus:outline-none focus:border-green-600 transition-colors shadow-sm">
                <span class="absolute left-3 top-3.5 text-gray-400">ğŸ”</span>
            </div>

            <!-- íƒ­ ë©”ë‰´ -->
            <div class="flex border-b border-gray-200 mb-4">
                <button class="main-tab active flex-1 py-3 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600" data-mode="distance">
                    ê±°ë¦¬ìˆœ ({allSpots.length})
                </button>
                <button class="main-tab flex-1 py-3 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600" data-mode="category">
                    ì¢…ë¥˜ë³„
                </button>
                <button class="main-tab flex-1 py-3 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600" data-mode="region">
                    ì§€ìì²´ë³„
                </button>
            </div>

            <!-- í•˜ìœ„ í•„í„° (ìë™ ìƒì„±ë¨) -->
            <div id="sub-filter-container" class="mb-6 hidden flex-wrap gap-2"></div>

            <!-- ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
            <div id="spot-list" class="space-y-3">
                {renderedSpots.map((spot) => (
                    <div class="spot-item group">
                        <!-- ì¹´ë“œ í—¤ë” (í´ë¦­ ì‹œ í¼ì³ì§) -->
                        <div class="spot-header bg-white rounded-lg border border-gray-200 p-5 cursor-pointer hover:shadow-md transition-all flex justify-between items-center"
                            data-title={spot.data.title}
                            data-category={spot.data.category}
                            data-region={spot.data.region}
                            data-distance={spot.data.distance}
                        >
                            <div class="flex items-center gap-3">
                                <!-- ë±ƒì§€ -->
                                <div class="flex flex-col gap-1 items-start">
                                    <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100">{spot.data.region}</span>
                                    <span class={`text-[10px] px-2 py-0.5 rounded border ${
                                        spot.data.category === 'ìì—°' ? 'bg-green-50 text-green-700 border-green-100' :
                                        spot.data.category === 'ë¬¸í™”ìœ ì‚°' ? 'bg-orange-50 text-orange-700 border-orange-100' :
                                        'bg-gray-100 text-gray-600 border-gray-200'
                                    }`}>{spot.data.category}</span>
                                </div>
                                <h2 class="text-lg font-bold text-gray-800">{spot.data.title}</h2>
                            </div>
                            
                            <div class="text-right">
                                <div class="text-base font-bold text-green-700">{spot.data.distance}km</div>
                                <div class="text-xs text-gray-400">({spot.data.time})</div>
                            </div>
                        </div>

                        <!-- ìƒì„¸ ë‚´ìš© (ì•„ì½”ë””ì–¸ - ìˆ¨ê²¨ì§) -->
                        <div class="detail-area hidden bg-gray-50 border-x border-b border-gray-200 rounded-b-lg p-5">
                             <!-- ì§€ë„ ì˜ì—­ -->
                             <div id={`map-${spot.slug}`} class="w-full h-64 bg-gray-200 rounded-lg mb-4 relative" data-lat={spot.data.lat} data-lng={spot.data.lng}>
                                <div class="absolute inset-0 flex items-center justify-center text-gray-400">ì§€ë„ ë¡œë”© ì¤‘...</div>
                            </div>
                            
                            <p class="text-sm text-gray-500 mb-4 flex items-center">ğŸ“ {spot.data.address}</p>

                            <!-- ë³¸ë¬¸ -->
                            <div class="prose prose-sm max-w-none mb-6 text-gray-700">
                                <spot.Content />
                            </div>

                            <!-- í•˜ë‹¨ ë²„íŠ¼ 3ê°œ (í•œ ì¤„ ë°°ì¹˜) -->
                            <div class="flex gap-2">
                                <a href={`https://www.google.com/search?q=${spot.data.region} ${spot.data.title}`} target="_blank" class="flex-1 py-2.5 bg-white border border-gray-300 rounded text-center text-sm font-bold text-gray-700 hover:bg-gray-100">
                                    G êµ¬ê¸€
                                </a>
                                <a href={`https://www.youtube.com/results?search_query=${spot.data.region} ${spot.data.title}`} target="_blank" class="flex-1 py-2.5 bg-white border border-gray-300 rounded text-center text-sm font-bold text-gray-700 hover:bg-gray-100">
                                    ğŸ“º ìœ íŠœë¸Œ
                                </a>
                                <a href={`https://exam1-beige.vercel.app/?q=${spot.data.title}`} target="_blank" class="flex-1 py-2.5 bg-green-600 text-white rounded text-center text-sm font-bold hover:bg-green-700">
                                    ğŸ›ï¸ êµ­ê°€ìœ ì‚°
                                </a>
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            <div id="no-result" class="hidden text-center py-10 text-gray-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </main>

        <style>
            .main-tab.active { color: #1f2937; border-color: #1f2937; }
            .sub-chip { display: inline-block; padding: 6px 14px; font-size: 0.9rem; font-weight: 500; color: #4b5563; background-color: white; border: 1px solid #d1d5db; border-radius: 9999px; cursor: pointer; transition: all 0.2s; }
            .sub-chip:hover { background-color: #f3f4f6; }
            .sub-chip.active { background-color: #1f2937; color: white; border-color: #1f2937; }
        </style>

        <!-- ë°ì´í„°ë¥¼ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë„˜ê¸°ê¸° ìœ„í•œ JSON -->
        <script define:vars={{ categoryCounts, regionCounts }}>
            window.categoryCounts = categoryCounts;
            window.regionCounts = regionCounts;
        </script>

        <script>
            const searchInput = document.getElementById('searchInput');
            const container = document.getElementById('spot-list');
            const mainTabs = document.querySelectorAll('.main-tab');
            const subFilterContainer = document.getElementById('sub-filter-container');
            const noResult = document.getElementById('no-result');
            
            const spotItems = document.querySelectorAll('.spot-item');
            const categories = ["ìì—°", "ë¬¸í™”ìœ ì‚°", "êµ­ë¦½ê³µì›ì‹œì„¤", "ì •ì›", "ê¸°íƒ€"]; 
            const regions = ["êµ¬ë¡€", "í•˜ë™", "ë‚¨ì›", "ìˆœì²œ", "í•¨ì–‘", "ì‚°ì²­", "ê³¡ì„±"]; 

            // 1. ì•„ì½”ë””ì–¸ ê¸°ëŠ¥ & ì§€ë„ ë¡œë“œ
            document.querySelectorAll('.spot-header').forEach(header => {
                header.addEventListener('click', () => {
                    const detail = header.nextElementSibling;
                    const isClosed = detail.classList.contains('hidden');
                    
                    // ë‹¤ë¥¸ ì—´ë¦° ê²ƒë“¤ ë‹«ê¸° (ì„ íƒ ì‚¬í•­ - í•˜ë‚˜ë§Œ ì—´ê³  ì‹¶ìœ¼ë©´ ì£¼ì„ í•´ì œ)
                    // document.querySelectorAll('.detail-area').forEach(d => d.classList.add('hidden'));

                    if(isClosed) {
                        detail.classList.remove('hidden');
                        // ì§€ë„ ë¡œë“œ
                        const mapDiv = detail.querySelector('[id^="map-"]');
                        if(mapDiv && !mapDiv.hasAttribute('data-loaded')) {
                            const lat = mapDiv.getAttribute('data-lat');
                            const lng = mapDiv.getAttribute('data-lng');
                            if(lat && lng) {
                                loadMap(mapDiv.id, parseFloat(lat), parseFloat(lng));
                                mapDiv.setAttribute('data-loaded', 'true');
                            } else {
                                mapDiv.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400">ì¢Œí‘œ ì •ë³´ ì—†ìŒ</div>';
                            }
                        }
                    } else {
                        detail.classList.add('hidden');
                    }
                });
            });

            function loadMap(elementId, lat, lng) {
                if (typeof naver === "undefined") return;
                const map = new naver.maps.Map(elementId, {
                    center: new naver.maps.LatLng(lat, lng),
                    zoom: 14
                });
                new naver.maps.Marker({ position: new naver.maps.LatLng(lat, lng), map: map });
            }

            // 2. íƒ­ ë° í•„í„°
            mainTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    mainTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const mode = tab.getAttribute('data-mode');
                    
                    if (mode === 'distance') {
                        subFilterContainer.classList.add('hidden');
                        resetFilter(); 
                        sortByDistance();
                    } else if (mode === 'category') {
                        renderSubChips(categories, 'category');
                    } else if (mode === 'region') {
                        renderSubChips(regions, 'region');
                    }
                });
            });

            function renderSubChips(items, type) {
                subFilterContainer.classList.remove('hidden');
                subFilterContainer.style.display = 'flex';
                subFilterContainer.style.flexWrap = 'wrap'; 
                subFilterContainer.style.gap = '8px';
                subFilterContainer.innerHTML = '';
                
                // ì „ì²´ ë²„íŠ¼
                const allBtn = createChip('ì „ì²´', true, () => {
                    resetFilter();
                    updateActiveChip(allBtn);
                });
                subFilterContainer.appendChild(allBtn);

                // ê°œë³„ ë²„íŠ¼ (ì¹´ìš´íŠ¸ í¬í•¨)
                items.forEach(item => {
                    const count = (type === 'category' ? window.categoryCounts[item] : window.regionCounts[item]) || 0;
                    if(count > 0) {
                        const btn = createChip(`${item} (${count})`, false, () => {
                            filterList(type, item);
                            updateActiveChip(btn);
                        });
                        subFilterContainer.appendChild(btn);
                    }
                });
            }

            function createChip(text, isActive, onClick) {
                const btn = document.createElement('button');
                btn.className = `sub-chip ${isActive ? 'active' : ''}`;
                btn.innerText = text;
                btn.onclick = onClick;
                return btn;
            }

            function updateActiveChip(activeBtn) {
                document.querySelectorAll('.sub-chip').forEach(c => c.classList.remove('active'));
                activeBtn.classList.add('active');
            }

            function filterList(type, value) {
                let visibleCount = 0;
                spotItems.forEach(item => {
                    const header = item.querySelector('.spot-header');
                    const cardValue = header.getAttribute(`data-${type}`);
                    if (cardValue === value) { item.style.display = 'block'; visibleCount++; } 
                    else { item.style.display = 'none'; }
                });
                checkEmpty(visibleCount);
            }

            function resetFilter() {
                spotItems.forEach(item => item.style.display = 'block');
                checkEmpty(spotItems.length);
            }

            function sortByDistance() {
                const sorted = Array.from(spotItems).sort((a, b) => {
                    const distA = parseFloat(a.querySelector('.spot-header').getAttribute('data-distance'));
                    const distB = parseFloat(b.querySelector('.spot-header').getAttribute('data-distance'));
                    return distA - distB;
                });
                container.innerHTML = '';
                sorted.forEach(item => container.appendChild(item));
            }

            searchInput.addEventListener('input', (e) => {
                const keyword = e.target.value.toLowerCase();
                let visibleCount = 0;
                spotItems.forEach(item => {
                    const header = item.querySelector('.spot-header');
                    const title = header.getAttribute('data-title').toLowerCase();
                    if (title.includes(keyword)) { item.style.display = 'block'; visibleCount++; } 
                    else { item.style.display = 'none'; }
                });
                checkEmpty(visibleCount);
            });

            function checkEmpty(count) {
                noResult.style.display = count === 0 ? 'block' : 'none';
            }
        </script>
	</body>
</html>